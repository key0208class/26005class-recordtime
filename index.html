<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è“®å°çµ‚é»è¨ˆæ™‚çµ„ v1.6.0 (Firebase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
        //
        //    ğŸ‘‰ è«‹å°‡æ‚¨åœ¨ Firebase æ­¥é©Ÿ 2 è¤‡è£½çš„ `firebaseConfig` è²¼åœ¨é€™è£¡
        //
 const firebaseConfig = {
  apiKey: "AIzaSyDwVzBE6JSC9UhFQ2rGyzRX1wCae-YhUYI",
  authDomain: "myclass26005-recordtime.firebaseapp.com",
  projectId: "myclass26005-recordtime",
  storageBucket: "myclass26005-recordtime.firebasestorage.app",
  messagingSenderId: "902094530267",
  appId: "1:902094530267:web:ad4d7709c1835d02564efe"
};

        //
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        // ã€v1.6.0ã€‘ åˆå§‹åŒ– Firebase
        try {
            if (typeof firebaseConfig !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                console.log("Firebase åˆå§‹åŒ–æˆåŠŸï¼");
            } else {
                console.warn("Firebase Config æœªè¨­å®šï¼Œå°‡ä»¥æœ¬æ©Ÿæ¨¡å¼é‹è¡Œã€‚");
            }
        } catch (e) {
            console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
        }
    </script>
    
    <style>
        /* (åŒ v1.5.1) */
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f3f4f6; font-size: 17px; }
        .modal { transition: opacity 0.25s ease, transform 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        .modal.hidden { opacity: 0; transform: scale(0.95); pointer-events: none; }
        .modal.visible { opacity: 1; transform: scale(1); }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 8px; font-size: 16px; z-index: 200; opacity: 0; transition: opacity 0.3s ease, bottom 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .toast.show { opacity: 1; bottom: 40px; }
        .toast-success { background-color: #28a745; color: white; }
        .toast-error { background-color: #dc3545; color: white; }
        .time-cell { cursor: pointer; text-align: center; padding: 12px 6px; font-family: 'monospace', 'Courier New'; font-size: 1.1rem; transition: background-color 0.2s ease, color 0.2s ease; min-width: 100px; vertical-align: top; }
        .time-cell:hover { background-color: #eff6ff; }
        .time-cell.empty { color: #9ca3af; }
        .time-cell.error { color: #ef4444; font-weight: bold; background-color: #fee2e2; animation: pulse-red 0.8s ease-in-out; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .event-name-input { border: 1px solid #3b82f6; border-radius: 4px; padding: 4px 8px; width: 95%; }
        .cell-action-btn { background: none; border: none; cursor: pointer; padding: 4px; border-radius: 6px; transition: background-color 0.2s; }
        .cell-action-btn:hover { background-color: #e5e7eb; }
        .cell-action-btn svg { width: 1.25rem; height: 1.25rem; }
        .btn-icon-edit { color: #3b82f6; }
        .btn-icon-save { color: #16a34a; }
        .btn-icon-delete { color: #dc2626; }
        .header-action-btn { display: inline-flex; align-items: center; justify-content: center; background-color: #4f46e5; color: white; font-weight: 500; padding: 6px; border-radius: 6px; transition: background-color 0.2s; width: 32px; height: 32px; cursor: pointer; font-size: 1.25rem; line-height: 1; }
        .header-action-btn:hover { background-color: #4338ca; }
        .saved-record-item { display: flex; align-items: center; background-color: #fdfba2; border: 1px solid #e7d98b; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s ease; }
        .saved-record-item:hover { transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .saved-record-btn { background: none; border: none; color: #725a03; padding: 4px 10px; font-size: 0.875rem; font-weight: 500; cursor: pointer; }
        .saved-record-btn:hover { background-color: #fcf891; }
        .delete-record-btn { background: #fcf891; color: #a18a07; padding: 4px 8px; border: none; border-left: 1px solid #e7d98b; cursor: pointer; height: 100%; transition: background-color 0.2s, color 0.2s; }
        .delete-record-btn:hover { background: #ef4444; color: white; }
        .delete-record-btn svg { width: 1rem; height: 1rem; }
        .btn-disabled { opacity: 0.6; cursor: not-allowed; background-color: #9ca3af; }
        .btn-disabled:hover { background-color: #9ca3af; }
        .conflict-btn-container { display: flex; justify-content: center; align-items: center; gap: 4px; margin-top: 4px; }
        .conflict-btn { background-color: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; border-radius: 6px; padding: 2px 4px; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; font-size: 0.75rem; font-weight: 500; transition: background-color 0.2s, color 0.2s; }
        .conflict-btn:hover { background-color: #fee2e2; color: #991b1b; }
        .conflict-btn svg { width: 0.875rem; height: 0.875rem; }
        .cell-sort-btn { background-color: #fef2f2; color: #b91c1c; border: none; padding: 4px; border-radius: 6px; transition: background-color 0.2s; cursor: pointer; }
        .cell-sort-btn:hover { background-color: #fee2e2; }
        .cell-sort-btn svg { width: 1.25rem; height: 1.25rem; }
        
        /* ã€v1.6.0ã€‘é€£ç·šç‹€æ…‹æŒ‡ç¤ºç‡ˆ */
        .connection-status {
            display: inline-flex; align-items: center; gap: 6px;
            font-size: 0.875rem; padding: 4px 10px;
            border-radius: 12px; font-weight: 500;
        }
        .status-dot {
            width: 10px; height: 10px; border-radius: 50%;
            animation: pulse-animation 2s infinite;
        }
        .status-connected { background-color: #dcfce7; color: #166534; }
        .status-connected .status-dot { background-color: #22c55e; }
        .status-disconnected { background-color: #fee2e2; color: #991b1b; }
        .status-disconnected .status-dot { background-color: #ef4444; }
        @keyframes pulse-animation {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* (åŒ v1.4.0) åˆ—å°æ¨£å¼ */
        @media print {
            body { font-size: 12px; background-color: white; }
            header, footer, #event-modal, #time-input-modal, #save-record-modal, #custom-confirm-modal, #actions-modal, #btn-open-modal, #toast-container, .no-print {
                display: none !important;
            }
            /* ... (å…¶ä»–åˆ—å°æ¨£å¼ä¿æŒä¸è®Š) ... */
            .container { max-w-full; padding: 0; margin: 0; }
            .bg-white { box-shadow: none; border-radius: 0; overflow: visible; }
            .overflow-x-auto { overflow: visible; }
            table { width: 100%; min-width: 0; border-collapse: collapse; border: 1px solid #ccc; }
            th, td { border: 1px solid #ccc; padding: 6px 8px; font-size: 11px; }
            thead { background-color: #e5e7eb !important; color: #1f2937 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            tr { page-break-inside: avoid; }
            .time-cell { font-size: 12px; min-width: auto; padding: 6px 4px; }
            .event-name-input, .cell-action-btn, .conflict-btn-container, .cell-sort-btn { display: none; }
            .event-name { font-size: 12px; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">

    <div id="toast-container"></div>

    <div class="container mx-auto max-w-7xl">
        
        <header class="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
            
            <div class="flex items-center gap-3 flex-wrap">
                <h1 class="text-3xl font-bold text-gray-800">ğŸ… è“®å°çµ‚é»è¨ˆæ™‚çµ„ v1.6.0</h1>
                
                <div id="connection-status-container" class="no-print">
                    <div class="connection-status status-disconnected">
                        <div class="status-dot"></div>
                        <span>é›¢ç·š</span>
                    </div>
                </div>

                <div id="saved-records-container" class="flex flex-wrap gap-2 items-center">
                    </div>
            </div>

            <div class="flex items-center bg-white rounded-lg shadow-sm p-2 gap-2 no-print">
                <span class="text-gray-700 mr-2 font-medium">é¡¯ç¤ºåæ¬¡ï¼š</span>
                <button id="btn-rank-minus" class="bg-gray-200 text-gray-700 hover:bg-gray-300 rounded-full w-8 h-8 flex items-center justify-center transition duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>
                </button>
                <span id="rank-count-display" class="mx-2 text-lg font-bold text-blue-600 w-8 text-center">7</span>
                <button id="btn-rank-plus" class="bg-gray-200 text-gray-700 hover:bg-gray-300 rounded-full w-8 h-8 flex items-center justify-center transition duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                </button>
            </div>
        </header>

        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="overflow-x-auto">
                <table id="events-table" class="w-full min-w-[1000px]">
                    <thead class="bg-blue-600 text-white">
                        </thead>
                    <tbody id="events-table-body" class="text-gray-700">
                        </tbody>
                </table>
            </div>
            <footer class="p-4 border-t border-gray-200 no-print">
                <button id="btn-open-modal" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span>æ–°å¢é …ç›®</span>
                </button>
            </footer>
        </div>
    </div>

    <div id="event-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 no-print">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 sm:p-8 transform">
            <header class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">æ–°å¢é‹å‹•é …ç›® ğŸƒ</h2>
                <button id="btn-close-modal" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </header>
            <form id="event-form">
                <div class="space-y-5">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label for="select-grade" class="block text-sm font-medium text-gray-700 mb-1">å¹´ç´š</label>
                            <select id="select-grade" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="ä¸€">ä¸€å¹´ç´š</option><option value="äºŒ">äºŒå¹´ç´š</option><option value="ä¸‰">ä¸‰å¹´ç´š</option><option value="å››">å››å¹´ç´š</option><option value="äº”">äº”å¹´ç´š</option><option value="å…­">å…­å¹´ç´š</option>
                            </select>
                        </div>
                        <div>
                            <label for="select-gender" class="block text-sm font-medium text-gray-700 mb-1">æ€§åˆ¥</label>
                            <select id="select-gender" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="ç”·">ç”·ç”Ÿ</option><option value="å¥³">å¥³ç”Ÿ</option><option value="æ··">æ··åˆ</option>
                            </select>
                        </div>
                        <div>
                            <label for="select-event" class="block text-sm font-medium text-gray-700 mb-1">é …ç›®</label>
                            <select id="select-event" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="60M">60M</option><option value="100M">100M</option><option value="200M">200M</option><option value="400Mæ¥åŠ›">400Mæ¥åŠ›</option><option value_A="å¤§éšŠæ¥åŠ›A">å¤§éšŠæ¥åŠ›A</option><option value="å¤§éšŠæ¥åŠ›B">å¤§éšŠæ¥åŠ›B</option><option value="è¶£å‘³ç«¶è³½">è¶£å‘³ç«¶è³½</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="input-custom-name" class="block text-sm font-medium text-gray-700 mb-1">è‡ªè¨‚é …ç›®åç¨± (å–®é …)</label>
                        <input type="text" id="input-custom-name" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="ä¾‹å¦‚ï¼šäºŒå¹´ç´š60mè¶£å‘³è³½è·‘">
                    </div>
                    <div class="flex items-center">
                        <span class="flex-grow border-t border-gray-300"></span>
                        <span class="mx-4 text-gray-500 text-sm">æˆ–</span>
                        <span class="flex-grow border-t border-gray-300"></span>
                    </div>
                    <div>
                        <label for="batch-event-input" class="block text-sm font-medium text-gray-700 mb-1">æ‰¹æ¬¡é …ç›®è¼¸å…¥ (æ¯è¡Œä¸€å€‹)</label>
                        <textarea id="batch-event-input" rows="5" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="ä¸‰å¥³100m&#10;ä¸‰ç”·100m&#10;å››å¥³100m..."></textarea>
                        <p class="mt-1 text-xs text-gray-500">å¦‚æœå¡«å¯«æ­¤æ¬„ï¼Œå°‡å„ªå…ˆæ‰¹æ¬¡æ–°å¢ã€‚</p>
                    </div>
                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button" id="btn-cancel-modal" class="bg-gray-200 text-gray-700 hover:bg-gray-300 font-medium py-2 px-5 rounded-lg transition duration-200">
                            å–æ¶ˆ
                        </button>
                        <button type="submit" id="btn-save-event" class="bg-blue-600 text-white hover:bg-blue-700 font-medium py-2 px-5 rounded-lg transition duration-200">
                            å„²å­˜é …ç›®
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div id="time-input-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4 no-print">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 sm:p-8 transform">
            <h2 id="time-modal-title" class="text-xl font-bold text-gray-800 mb-6">è¼¸å…¥æ™‚é–“ (ç¬¬ 1 å)</h2>
            <form id="time-input-form">
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label for="time-min" class="block text-sm font-medium text-gray-700 text-center">åˆ† (M)</label>
                        <input type="number" id="time-min" min="0" max="59" class="w-full text-center text-lg p-3 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="time-sec" class="block text-sm font-medium text-gray-700 text-center">ç§’ (S)</label>
                        <input type="number" id="time-sec" min="0" max="59" class="w-full text-center text-lg p-3 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="time-cs" class="block text-sm font-medium text-gray-700 text-center">æ¯«ç§’ (CS)</label>
                        <input type="number" id="time-cs" min="0" max="99" class="w-full text-center text-lg p-3 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                </div>
                <div class="flex justify-between items-center pt-6">
                    <button type="button" id="btn-delete-time" class="bg-red-100 text-red-700 hover:bg-red-200 font-medium py-2 px-5 rounded-lg transition duration-200">
                        åˆªé™¤
                    </button>
                    <div class="flex gap-3">
                        <button type="button" id="btn-cancel-time" class="bg-gray-200 text-gray-700 hover:bg-gray-300 font-medium py-2 px-5 rounded-lg transition duration-200">
                            å–æ¶ˆ
                        </button>
                        <button type="submit" class="bg-blue-600 text-white hover:bg-blue-700 font-medium py-2 px-5 rounded-lg transition duration-200">
                            å„²å­˜
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div id="save-record-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4 no-print">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 sm:p-8 transform">
            <h2 class="text-xl font-bold text-gray-800 mb-6">å„²å­˜ç›®å‰ç´€éŒ„ ğŸ’¾</h2>
            <form id="save-record-form">
                <div>
                    <label for="record-title" class="block text-sm font-medium text-gray-700 mb-1">ç´€éŒ„æ¨™é¡Œ</label>
                    <input type="text" id="record-title" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="ä¾‹å¦‚ï¼š11/28 ä¸Šåˆ (æœ¬æ©Ÿå¿«ç…§)" required>
                </div>
                <div class="flex justify-end gap-3 pt-6">
                    <button type="button" id="btn-cancel-save-record" class="bg-gray-200 text-gray-700 hover:bg-gray-300 font-medium py-2 px-5 rounded-lg transition duration-200">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="bg-blue-600 text-white hover:bg-blue-700 font-medium py-2 px-5 rounded-lg transition duration-200">
                        å„²å­˜
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div id="custom-confirm-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[70] p-4 no-print">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md p-6 sm:p-8 transform">
            <div class="flex items-start gap-4">
                <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0">
                    <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126z" />
                    </svg>
                </div>
                <div class="mt-0 sm:ml-4 text-left">
                    <h3 class="text-xl font-semibold leading-6 text-gray-900" id="custom-confirm-title">ç¢ºèªåˆªé™¤</h3>
                    <div class="mt-2">
                        <p class="text-base text-gray-600" id="custom-confirm-message">æ‚¨ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚</p>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="custom-confirm-cancel" class="bg-gray-200 text-gray-700 hover:bg-gray-300 font-medium py-2 px-5 rounded-lg transition duration-200">
                    å–æ¶ˆ
                </button>
                <button type="button" id="custom-confirm-ok" class="bg-red-600 text-white hover:bg-red-700 font-medium py-2 px-5 rounded-lg transition duration-200 btn-disabled" disabled>
                    ç¢ºå®šåˆªé™¤ (3)
                </button>
            </div>
        </div>
    </div>
    <div id="actions-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 no-print">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-xs p-6 transform">
            <header class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">æ“ä½œé¸å–® âš™ï¸</h2>
                <button id="btn-close-actions-modal" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </header>
            <div class="space-y-3">
                <button id="btn-action-save" class="w-full flex items-center justify-center gap-2 bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-5 rounded-lg transition duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                    å„²å­˜ (æœ¬æ©Ÿå¿«ç…§)
                </button>
                <button id="btn-action-export-html" class="w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-5 rounded-lg transition duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                    ç¶²é  (HTML)
                </button>
                <button id="btn-action-delete-all" class="w-full flex items-center justify-center gap-2 bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-5 rounded-lg transition duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    åˆªé™¤å…¨éƒ¨é …ç›®
                </button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- ã€v1.6.0ã€‘Firebase ç›¸é—œè¨­å®š ---
            const LOCAL_STORAGE_KEY = 'hlesStopwatchApp_localSaves'; // v1.6.0 æ›´æ”¹keyä»¥å€åˆ†
            let db; // Firebase Database å¯¦ä¾‹
            const APP_DATA_PATH = 'appData'; // Firebase ä¸Šçš„ä¸»ç¯€é»
            
            // æª¢æŸ¥ Firebase æ˜¯å¦æˆåŠŸåˆå§‹åŒ–
            const isFirebaseEnabled = (typeof firebase !== 'undefined' && typeof firebaseConfig !== 'undefined');
            if (isFirebaseEnabled) {
                try {
                    db = firebase.database();
                    console.log("Firebase Database å¯¦ä¾‹å·²å–å¾—ã€‚");
                } catch(e) {
                    console.error("ç„¡æ³•å–å¾— Firebase Database å¯¦ä¾‹:", e);
                }
            } else {
                console.warn("Firebase æœªå•Ÿç”¨ï¼Œå°‡ä»¥ã€Œé›¢ç·šæœ¬æ©Ÿæ¨¡å¼ã€é‹è¡Œã€‚");
            }


            // --- æœ¬æ©Ÿç‹€æ…‹ (State) ---
            // ã€v1.6.0ã€‘ 
            // state ç¾åœ¨æ˜¯ Firebase çš„ã€Œæœ¬æ©Ÿé¡åƒã€ã€‚
            // æˆ‘å€‘ä¸å†ã€Œç›´æ¥ã€ä¿®æ”¹ stateï¼Œè€Œæ˜¯ä¿®æ”¹ Firebaseã€‚
            // Firebase æœƒè‡ªå‹•åŒæ­¥ stateï¼Œç„¶å¾Œæˆ‘å€‘å†æ ¹æ“š state æ¸²æŸ“ç•«é¢ã€‚
            let state = {
                rankCount: 7, maxRank: 12, minRank: 1,
                events: [], // å°‡ç”± Firebase åŒæ­¥
                savedRecords: [], // ã€v1.6.0ã€‘é€™éƒ¨åˆ†ä»ä¿ç•™åœ¨æœ¬æ©Ÿ (localStorage)
                editingTime: { eventIndex: null, rank: null }, //ã€v1.6.0ã€‘æ³¨æ„ï¼šID å·²æ”¹ç‚º Index
                confirmCallback: null, confirmInterval: null, 
                deleteTimeConfirmation: false, deleteTimeTimeout: null 
            };

            // --- DOM ç¯€é» (v1.5.0) ---
            const rankCountDisplay = document.getElementById('rank-count-display');
            const btnRankMinus = document.getElementById('btn-rank-minus');
            const btnRankPlus = document.getElementById('btn-rank-plus');
            const tableHead = document.querySelector('#events-table thead');
            const tableBody = document.getElementById('events-table-body');
            const toastContainer = document.getElementById('toast-container');
            const eventModal = document.getElementById('event-modal');
            const btnOpenModal = document.getElementById('btn-open-modal');
            const btnCloseModal = document.getElementById('btn-close-modal');
            const btnCancelModal = document.getElementById('btn-cancel-modal');
            const eventForm = document.getElementById('event-form');
            const selectGrade = document.getElementById('select-grade');
            const selectGender = document.getElementById('select-gender');
            const selectEvent = document.getElementById('select-event');
            const inputCustomName = document.getElementById('input-custom-name');
            const batchEventInput = document.getElementById('batch-event-input');
            const timeInputModal = document.getElementById('time-input-modal');
            const timeModalTitle = document.getElementById('time-modal-title');
            const timeInputForm = document.getElementById('time-input-form');
            const timeMin = document.getElementById('time-min');
            const timeSec = document.getElementById('time-sec');
            const timeCs = document.getElementById('time-cs');
            const btnCancelTime = document.getElementById('btn-cancel-time');
            const btnDeleteTime = document.getElementById('btn-delete-time');
            const savedRecordsContainer = document.getElementById('saved-records-container');
            const saveRecordModal = document.getElementById('save-record-modal');
            const saveRecordForm = document.getElementById('save-record-form');
            const recordTitleInput = document.getElementById('record-title');
            const btnCancelSaveRecord = document.getElementById('btn-cancel-save-record');
            const customConfirmModal = document.getElementById('custom-confirm-modal');
            const customConfirmTitle = document.getElementById('custom-confirm-title');
            const customConfirmMessage = document.getElementById('custom-confirm-message');
            const customConfirmCancel = document.getElementById('custom-confirm-cancel');
            const customConfirmOk = document.getElementById('custom-confirm-ok');
            const actionsModal = document.getElementById('actions-modal');
            const btnCloseActionsModal = document.getElementById('btn-close-actions-modal');
            const btnActionSave = document.getElementById('btn-action-save');
            const btnActionExportHtml = document.getElementById('btn-action-export-html');
            const btnActionDeleteAll = document.getElementById('btn-action-delete-all');
            const connectionStatusContainer = document.getElementById('connection-status-container'); //ã€v1.6.0ã€‘


            // --- è¼”åŠ©å·¥å…· (Helpers) ---

            // (v1.5.0) æç¤ºè¨Šæ¯
            function showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type === 'success' ? 'toast-success' : 'toast-error'}`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => { toast.classList.add('show'); }, 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.parentNode?.removeChild(toast));
                }, 3000);
            }

            // (åŒ v1.4.0) æ ¼å¼åŒ–æ™‚é–“
            function formatMillis(ms) {
                if (ms === undefined || ms === null || isNaN(ms)) {
                    return "---";
                }
                const totalCentiseconds = Math.round(ms / 10);
                const minutes = Math.floor(totalCentiseconds / 6000);
                const remainingCentiseconds = totalCentiseconds % 6000;
                const seconds = Math.floor(remainingCentiseconds / 100);
                const centiseconds = remainingCentiseconds % 100;
                const pad = (n) => String(n).padStart(2, '0');
                if (minutes > 0) {
                    return `${pad(minutes)}'${pad(seconds)}"${pad(centiseconds)}`;
                } else {
                    return `${pad(seconds)}"${pad(centiseconds)}`;
                }
            }
            // (åŒ v1.4.0) è§£ææ™‚é–“
            function parseTime(min, sec, cs) {
                min = parseInt(min, 10) || 0;
                sec = parseInt(sec, 10) || 0;
                cs = parseInt(cs, 10) || 0;
                if (min === 0 && sec === 0 && cs === 0 && (timeMin.value === '' && timeSec.value === '' && timeCs.value === '')) {
                     return null;
                }
                if (min === 0 && sec === 0 && cs === 0) return 0;
                return (min * 60000) + (sec * 1000) + (cs * 10);
            }
            // (åŒ v1.4.0) å„²å­˜ "æœ¬æ©Ÿå¿«ç…§"
            function saveStateToLocalStorage() {
                try {
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(state.savedRecords));
                } catch (e) { console.error("ç„¡æ³•å„²å­˜åˆ° LocalStorage:", e); showToast('å„²å­˜æœ¬æ©Ÿå¿«ç…§å¤±æ•—', 'error'); }
            }
            // (åŒ v1.4.0) è®€å– "æœ¬æ©Ÿå¿«ç…§"
            function loadStateFromLocalStorage() {
                try {
                    const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                    if (data) { state.savedRecords = JSON.parse(data); }
                } catch (e) { console.error("ç„¡æ³•å¾ LocalStorage è®€å–:", e); state.savedRecords = []; }
            }
            
            // (åŒ v1.4.0) ç¢ºèªè¦–çª—
            function showCustomConfirm(title, message, callback) {
                customConfirmTitle.textContent = title;
                customConfirmMessage.textContent = message;
                state.confirmCallback = callback;
                customConfirmOk.disabled = true;
                customConfirmOk.classList.add('btn-disabled');
                customConfirmOk.textContent = 'ç¢ºå®š (3)';
                let countdown = 3;
                if (state.confirmInterval) { clearInterval(state.confirmInterval); }
                state.confirmInterval = setInterval(() => {
                    countdown--;
                    if (countdown > 0) {
                        customConfirmOk.textContent = `ç¢ºå®š (${countdown})`;
                    } else {
                        clearInterval(state.confirmInterval);
                        state.confirmInterval = null;
                        customConfirmOk.textContent = 'ç¢ºå®š';
                        customConfirmOk.disabled = false;
                        customConfirmOk.classList.remove('btn-disabled');
                    }
                }, 1000);
                customConfirmModal.classList.remove('hidden');
                customConfirmModal.classList.add('visible');
            }
            // (åŒ v1.4.0)
            function hideCustomConfirm() {
                if (state.confirmInterval) { clearInterval(state.confirmInterval); state.confirmInterval = null; }
                customConfirmModal.classList.remove('visible');
                customConfirmModal.classList.add('hidden');
                state.confirmCallback = null;
                customConfirmOk.disabled = true;
                customConfirmOk.classList.add('btn-disabled');
                customConfirmOk.textContent = 'ç¢ºå®š (3)';
            }
            
            // --- æ¸²æŸ“åŠŸèƒ½ (Rendering) ---

            // ã€v1.6.0ã€‘
            // é€™äº› render å‡½å¼ç¾åœ¨åªä¾è³´ `state`ã€‚
            // ç”±æ–¼ Firebase æœƒè‡ªå‹•æ›´æ–° `state`ï¼Œç•«é¢å°±æœƒè‡ªå‹•æ›´æ–°ã€‚
            function renderTable() {
                renderTableHeader();
                renderTableBody();
            }

            // (åŒ v1.5.1) æ¸²æŸ“è¡¨é ­
            function renderTableHeader() {
                tableHead.innerHTML = '';
                const tr = document.createElement('tr');
                
                const thIndex = document.createElement('th');
                thIndex.textContent = 'åºè™Ÿ';
                thIndex.className = 'py-4 px-4 text-center w-16';
                tr.appendChild(thIndex);

                const thName = document.createElement('th');
                thName.className = 'py-4 px-4 text-left min-w-[250px]';
                const nameHeaderContainer = document.createElement('div');
                nameHeaderContainer.className = 'flex justify-between items-center gap-2';
                const spanName = document.createElement('span');
                spanName.textContent = 'é …ç›®';
                spanName.className = 'text-base';
                
                const headerActionsButton = document.createElement('button');
                headerActionsButton.id = 'btn-open-actions-modal';
                headerActionsButton.className = 'header-action-btn no-print';
                headerActionsButton.title = 'æ“ä½œé¸å–®';
                headerActionsButton.innerHTML = `âš™ï¸`; 
                
                nameHeaderContainer.appendChild(spanName);
                nameHeaderContainer.appendChild(headerActionsButton);
                thName.appendChild(nameHeaderContainer);
                tr.appendChild(thName);

                for (let i = 1; i <= state.rankCount; i++) {
                    const thRank = document.createElement('th');
                    thRank.textContent = `${i} å`;
                    thRank.className = 'py-4 px-3 text-center w-28';
                    tr.appendChild(thRank);
                }

                tableHead.appendChild(tr);
            }

            /**
             * ã€v1.6.0ã€‘æ¸²æŸ“è¡¨æ ¼ä¸»é«” (tbody)
             * - event.id æ”¹ç‚º index
             * - ranks[] æ”¹ç‚º ranks{} (ç‰©ä»¶)
             */
            function renderTableBody() {
                tableBody.innerHTML = ''; 

                // ã€v1.6.0ã€‘ ç¢ºä¿ state.events æ˜¯ä¸€å€‹é™£åˆ—
                const events = Array.isArray(state.events) ? state.events : [];

                if (events.length === 0) {
                    const tr = document.createElement('tr');
                    const td = document.createElement('td');
                    td.colSpan = 2 + state.rankCount; 
                    td.textContent = 'å°šæœªæ–°å¢ä»»ä½•é …ç›®ï¼Œè«‹é»æ“Šä¸‹æ–¹çš„ã€Œæ–°å¢é …ç›®ã€æŒ‰éˆ•ã€‚';
                    td.className = 'text-center text-gray-500 p-8';
                    tr.appendChild(td);
                    tableBody.appendChild(tr);
                    return;
                }

                events.forEach((event, index) => {
                    // ã€v1.6.0ã€‘ event å¯èƒ½ç‚º null (å¦‚æœFirebaseé™£åˆ—ä¸­æ–·)
                    if (!event) return; 

                    const tr = document.createElement('tr');
                    tr.className = 'border-b border-gray-200 hover:bg-blue-50 transition duration-150';
                    tr.dataset.eventIndex = index; //ã€v1.6.0ã€‘ID æ”¹ç‚º Index
                    if (index % 2 !== 0) {
                        tr.classList.add('bg-gray-50');
                    }

                    // 1. åºè™Ÿ
                    const tdIndex = document.createElement('td');
                    tdIndex.textContent = String(index + 1).padStart(2, '0');
                    tdIndex.className = 'py-3 px-4 text-center font-medium text-gray-600 text-lg';
                    tr.appendChild(tdIndex);

                    // 2. é …ç›®åç¨±
                    const tdName = document.createElement('td');
                    tdName.className = 'py-3 px-4 font-medium';
                    const flexContainer = document.createElement('div');
                    flexContainer.className = 'flex justify-between items-center';

                    const nameContainer = document.createElement('div');
                    const spanName = document.createElement('span');
                    spanName.className = 'event-name text-lg';
                    spanName.textContent = event.name;
                    const inputName = document.createElement('input');
                    inputName.type = 'text';
                    inputName.className = 'event-name-input hidden text-lg';
                    inputName.value = event.name;
                    nameContainer.appendChild(spanName);
                    nameContainer.appendChild(inputName);

                    // æŒ‰éˆ•å€
                    const buttonContainer = document.createElement('div');
                    buttonContainer.className = 'flex gap-1 no-print';
                    
                    const sortBtnContainer = document.createElement('span');
                    sortBtnContainer.id = `sort-btn-container-${index}`; //ã€v1.6.0ã€‘
                    sortBtnContainer.className = 'ml-1';
                    
                    buttonContainer.innerHTML = `
                        <button class="cell-action-btn btn-icon-edit btn-toggle-edit-icon">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897l8.93-8.93zM16.862 4.487l-8.93 8.93-1.688-1.688 8.93-8.93 1.688 1.688z"></path></svg>
                        </button>
                        <button class="cell-action-btn btn-icon-save btn-save-name-icon hidden">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        </button>
                        <button class="cell-action-btn btn-icon-delete btn-delete-event-icon hidden">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    `;
                    
                    buttonContainer.prepend(sortBtnContainer);
                    flexContainer.appendChild(nameContainer);
                    flexContainer.appendChild(buttonContainer);
                    tdName.appendChild(flexContainer);
                    tr.appendChild(tdName);

                    // 3. åæ¬¡è¼¸å…¥æ ¼
                    for (let i = 1; i <= state.rankCount; i++) {
                        const tdRank = document.createElement('td');
                        tdRank.className = 'time-cell';
                        tdRank.dataset.eventIndex = index; //ã€v1.6.0ã€‘
                        tdRank.dataset.rank = i;
                        tdRank.id = `cell-${index}-${i}`; //ã€v1.6.0ã€‘
                        
                        // ã€v1.6.0ã€‘ ranks å¯èƒ½æ˜¯ undefined æˆ– object
                        const timeInMs = (event.ranks && event.ranks[i]) ? event.ranks[i] : null;
                        const timeText = formatMillis(timeInMs);
                        
                        if (timeInMs === undefined || timeInMs === null) {
                            tdRank.classList.add('empty');
                        }
                        
                        const timeTextNode = document.createElement('div');
                        timeTextNode.textContent = timeText;
                        
                        const swapBtnContainer = document.createElement('div');
                        swapBtnContainer.id = `swap-btn-container-${index}-${i}`; //ã€v1.6.0ã€‘
                        swapBtnContainer.className = 'conflict-btn-container';
                        
                        tdRank.appendChild(timeTextNode);
                        tdRank.appendChild(swapBtnContainer);
                        tr.appendChild(tdRank);
                    }
                    tableBody.appendChild(tr);
                    validateEventRow(index); // ã€v1.6.0ã€‘æ¸²æŸ“å®Œç•¢å¾Œç«‹å³é©—è­‰
                });
            }
            
            // (åŒ v1.4.0) æ¸²æŸ“æœ¬æ©Ÿå¿«ç…§æŒ‰éˆ•
            function renderSavedRecordsButtons() {
                savedRecordsContainer.innerHTML = '';
                state.savedRecords.forEach((record, index) => {
                    const item = document.createElement('div');
                    item.className = 'saved-record-item no-print';
                    item.innerHTML = `
                        <button class="saved-record-btn" data-index="${index}" title="è¼‰å…¥æ­¤å¿«ç…§ (å°‡è¦†è“‹é›²ç«¯)">
                            ğŸ“œ ${record.title}
                        </button>
                        <button class="delete-record-btn" data-index="${index}" title="åˆªé™¤æ­¤æœ¬æ©Ÿå¿«ç…§">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    `;
                    savedRecordsContainer.appendChild(item);
                });
            }

            // --- æ ¸å¿ƒåŠŸèƒ½ (Functions) ---

            // ã€v1.6.0ã€‘æ›´æ–°åæ¬¡ (å¯«å…¥ Firebase)
            function updateRankCount(change) {
                if (!isFirebaseEnabled) {
                    showToast('é›¢ç·šæ¨¡å¼ç„¡æ³•æ“ä½œ', 'error');
                    return;
                }
                const newCount = state.rankCount + change;
                if (newCount >= state.minRank && newCount <= state.maxRank) {
                    // state.rankCount = newCount; // ä¸å†ç›´æ¥ä¿®æ”¹ state
                    // rankCountDisplay.textContent = state.rankCount; // onValue æœƒè™•ç†
                    // renderTable(); // onValue æœƒè™•ç†
                    
                    // å¯«å…¥ Firebase
                    db.ref(`${APP_DATA_PATH}/rankCount`).set(newCount)
                        .catch(err => showToast(`åæ¬¡æ›´æ–°å¤±æ•—: ${err.message}`, 'error'));
                }
            }

            // (åŒ v1.4.0) é–‹å•Ÿ/é—œé–‰ Modal
            function openEventModal() {
                eventForm.reset();
                eventModal.classList.remove('hidden');
                eventModal.classList.add('visible');
            }
            function closeEventModal() {
                eventModal.classList.remove('visible');
                eventModal.classList.add('hidden');
            }

            // ã€v1.6.0ã€‘å„²å­˜æ–°é …ç›® (å¯«å…¥ Firebase)
            function handleSaveEvent(e) {
                e.preventDefault();
                if (!isFirebaseEnabled) {
                    showToast('é›¢ç·šæ¨¡å¼ç„¡æ³•æ“ä½œ', 'error');
                    return;
                }

                const batchInput = batchEventInput.value.trim();
                let addedCount = 0;
                let newEvents = [];

                if (batchInput) {
                    const eventNames = batchInput.split('\n').filter(name => name.trim() !== '');
                    eventNames.forEach(name => {
                        newEvents.push({
                            name: name.trim(),
                            ranks: {} // Firebase ä¸­ç©ºç‰©ä»¶å»ºè­°ç”¨ {}
                        });
                    });
                    addedCount = eventNames.length;
                } else {
                    const customName = inputCustomName.value.trim();
                    let eventName = '';
                    if (customName) { eventName = customName; }
                    else { eventName = `${selectGrade.value}${selectGender.value}${selectEvent.value}`; }
                    
                    if (eventName) {
                        newEvents.push({ name: eventName, ranks: {} });
                        addedCount = 1;
                    }
                }
                
                if (addedCount > 0) {
                    // å–å¾—ç›®å‰çš„ events é™£åˆ—ï¼Œé™„åŠ æ–°è³‡æ–™å¾Œï¼Œä¸€æ¬¡å¯«å›
                    const currentEvents = Array.isArray(state.events) ? [...state.events] : [];
                    const updatedEvents = currentEvents.concat(newEvents);
                    
                    db.ref(`${APP_DATA_PATH}/events`).set(updatedEvents)
                        .then(() => {
                            closeEventModal();
                            showToast(`æˆåŠŸæ–°å¢ ${addedCount} å€‹é …ç›®ï¼`);
                        })
                        .catch(err => showToast(`æ–°å¢å¤±æ•—: ${err.message}`, 'error'));

                } else {
                    showToast('è«‹è‡³å°‘å¡«å¯«ä¸€å€‹é …ç›®', 'error');
                }
            }

            // ã€v1.6.0ã€‘åˆªé™¤é …ç›® (å¯«å…¥ Firebase)
            function deleteEvent(eventIndex) {
                if (!isFirebaseEnabled) {
                    showToast('é›¢ç·šæ¨¡å¼ç„¡æ³•æ“ä½œ', 'error');
                    return;
                }
                
                const currentEvents = [...state.events];
                currentEvents.splice(eventIndex, 1);
                
                // ã€v1.6.0ã€‘ 
                // Firebase é™£åˆ—ä¸­åˆªé™¤
                // è¨»ï¼šè‹¥é™£åˆ—ä¸­æœ‰ nullï¼ŒFirebase æœƒå£“ç¸®é™£åˆ—ï¼Œå°è‡´ index è®Šå‹•ã€‚
                // ç‚ºäº†å®‰å…¨ï¼Œæˆ‘å€‘ç¸½æ˜¯ set å›å®Œæ•´çš„é™£åˆ—ã€‚
                db.ref(`${APP_DATA_PATH}/events`).set(currentEvents)
                    .then(() => showToast('é …ç›®å·²åˆªé™¤'))
                    .catch(err => showToast(`åˆªé™¤å¤±æ•—: ${err.message}`, 'error'));
            }

            // ã€v1.6.0ã€‘åˆªé™¤æ‰€æœ‰é …ç›® (å¯«å…¥ Firebase)
            function deleteAllEvents() {
                if (!isFirebaseEnabled) {
                    showToast('é›¢ç·šæ¨¡å¼ç„¡æ³•æ“ä½œ', 'error');
                    return;
                }
                db.ref(`${APP_DATA_PATH}/events`).set([])
                    .then(() => showToast('å·²åˆªé™¤æ‰€æœ‰é …ç›®'))
                    .catch(err => showToast(`åˆªé™¤å¤±æ•—: ${err.message}`, 'error'));
            }

            // (åŒ v1.4.0) åˆ‡æ›ç·¨è¼¯æ¨¡å¼ (ç´” DOM æ“ä½œ)
            function toggleEditMode(tr, save = false) {
                const spanName = tr.querySelector('.event-name');
                const inputName = tr.querySelector('.event-name-input');
                const btnToggleEdit = tr.querySelector('.btn-toggle-edit-icon');
                const btnSaveName = tr.querySelector('.btn-save-name-icon');
                const btnDeleteEvent = tr.querySelector('.btn-delete-event-icon');
                spanName.classList.toggle('hidden', !save);
                inputName.classList.toggle('hidden', save);
                btnToggleEdit.classList.toggle('hidden', !save);
                btnSaveName.classList.toggle('hidden', save);
                btnDeleteEvent.classList.toggle('hidden', save);
                if (!save) inputName.focus();
            }

            // ã€v1.6.0ã€‘å„²å­˜é …ç›®åç¨± (å¯«å…¥ Firebase)
            function saveEventName(eventIndex, tr) {
                if (!isFirebaseEnabled) {
                    showToast('é›¢ç·šæ¨¡å¼ç„¡æ³•æ“ä½œ', 'error');
                    return;
                }

                const inputName = tr.querySelector('.event-name-input');
                const newName = inputName.value.trim();
                if (!newName) { showToast('é …ç›®åç¨±ä¸å¯ç‚ºç©º', 'error'); return; }

                // ã€v1.6.0ã€‘åªæ›´æ–°è©²é …ç›®çš„åç¨±ï¼Œæ•ˆç‡é«˜
                const namePath = `${APP_DATA_PATH}/events/${eventIndex}/name`;
                db.ref(namePath).set(newName)
                    .then(() => {
                        // é›–ç„¶ onValue æœƒæ›´æ–°ï¼Œä½† DOM ç‹€æ…‹è¦æ‰‹å‹•åˆ‡æ›
                        tr.querySelector('.event-name').textContent = newName;
                        toggleEditMode(tr, true);
                        showToast('é …ç›®åç¨±å·²æ›´æ–°');
                    })
                    .catch(err => showToast(`æ›´æ–°å¤±æ•—: ${err.message}`, 'error'));
            }

            // ã€v1.6.0ã€‘é–‹å•Ÿæ™‚é–“è¼¸å…¥ (eventIndex)
            function openTimeInputModal(eventIndex, rank) {
                const event = state.events[eventIndex];
                if (!event) return;
                state.editingTime = { eventIndex, rank };
                timeModalTitle.textContent = `è¼¸å…¥ ${event.name} (ç¬¬ ${rank} å)`;
                
                const ms = (event.ranks && event.ranks[rank]) ? event.ranks[rank] : null;
                
                if (ms !== undefined && ms !== null) {
                    const totalCentiseconds = Math.round(ms / 10);
                    timeMin.value = Math.floor(totalCentiseconds / 6000);
                    const remainingCentiseconds = totalCentiseconds % 6000;
                    timeSec.value = Math.floor(remainingCentiseconds / 100);
                    timeCs.value = remainingCentiseconds % 100;
                } else {
                    timeInputForm.reset();
                }
                timeInputModal.classList.remove('hidden');
                timeInputModal.classList.add('visible');
                timeMin.focus();
            }
            
            // (åŒ v1.4.0)
            function closeTimeInputModal() {
                timeInputModal.classList.remove('visible');
                timeInputModal.classList.add('hidden');
                state.editingTime = { eventIndex: null, rank: null };
                if (state.deleteTimeTimeout) { clearTimeout(state.deleteTimeTimeout); state.deleteTimeTimeout = null; }
                state.deleteTimeConfirmation = false;
                btnDeleteTime.textContent = 'åˆªé™¤';
                btnDeleteTime.classList.remove('bg-red-500', 'text-white');
                btnDeleteTime.classList.add('bg-red-100', 'text-red-700');
            }

            // ã€v1.6.0ã€‘å„²å­˜æ™‚é–“ (å¯«å…¥ Firebase)
            function handleSaveTime(e) {
                e.preventDefault();
                if (!isFirebaseEnabled) {
                    showToast('é›¢ç·šæ¨¡å¼ç„¡æ³•æ“ä½œ', 'error');
                    return;
                }

                const { eventIndex, rank } = state.editingTime;
                if (eventIndex === null || rank === null) return;
                
                const totalMs = parseTime(timeMin.value, timeSec.value, timeCs.value);
                
                // ã€v1.6.0ã€‘è§£æ±ºåŒæ­¥å•é¡Œ (Req #2)
                // æˆ‘å€‘åªæ›´æ–°é€™ä¸€å€‹åæ¬¡çš„æ™‚é–“
                // é€™æ¨£è£åˆ¤Aæ›´æ–°ç¬¬1åï¼Œè£åˆ¤Bæ›´æ–°ç¬¬2åï¼Œä¸æœƒäº’ç›¸è¦†è“‹
                const timePath = `${APP_DATA_PATH}/events/${eventIndex}/ranks/${rank}`;
                
                db.ref(timePath).set(totalMs)
                    .then(() => {
                        closeTimeInputModal();
                        // onValue æœƒè‡ªå‹•è§¸ç™¼ validateEventRow (å› ç‚º renderTable æœƒè·‘)
                    })
                    .catch(err => showToast(`å„²å­˜æ™‚é–“å¤±æ•—: ${err.message}`, 'error'));
            }

            // ã€v1.6.0ã€‘åˆªé™¤æ™‚é–“ (å¯«å…¥ Firebase)
            function handleDeleteTimeInternalLogic() {
                if (!isFirebaseEnabled) {
                    showToast('é›¢ç·šæ¨¡å¼ç„¡æ³•æ“ä½œ', 'error');
                    return;
                }

                const { eventIndex, rank } = state.editingTime;
                if (eventIndex === null || rank === null) return;
                
                // ã€v1.6.0ã€‘å°‡è©²ç¯€é»è¨­ç‚º null (ç­‰æ–¼åˆªé™¤)
                const timePath = `${APP_DATA_PATH}/events/${eventIndex}/ranks/${rank}`;
                
                db.ref(timePath).set(null) // æˆ– .remove()
                    .then(() => {
                        closeTimeInputModal();
                        showToast('æ™‚é–“å·²æ¸…é™¤');
                        // onValue æœƒè‡ªå‹•è§¸ç™¼ validateEventRow
                    })
                    .catch(err => showToast(`åˆªé™¤æ™‚é–“å¤±æ•—: ${err.message}`, 'error'));
            }

            /**
             * ã€v1.6.0ã€‘æ™‚é–“è¡çªé©—è­‰
             * (æ­¤å‡½å¼é‚è¼¯èˆ‡ v1.5.0 ç›¸åŒï¼Œåªä¿®æ”¹ eventId -> eventIndex)
             */
            function validateEventRow(eventIndex) {
                const event = state.events[eventIndex];
                if (!event) return;
                const ranks = event.ranks || {}; // ã€v1.6.0ã€‘ ç¢ºä¿ ranks æ˜¯ç‰©ä»¶
                let lastValidTime = -1;
                let lastValidRank = 0;
                let errors = []; 
                let conflictRanks = new Set(); 
                let allRanksWithTime = []; 

                // 1. æ¸…é™¤èˆŠç‹€æ…‹
                for (let i = 1; i <= state.rankCount; i++) {
                    const cell = document.getElementById(`cell-${eventIndex}-${i}`);
                    if (cell) {
                        cell.classList.remove('error');
                        const swapContainer = document.getElementById(`swap-btn-container-${eventIndex}-${i}`);
                        if (swapContainer) swapContainer.innerHTML = '';
                    }
                }
                const sortContainer = document.getElementById(`sort-btn-container-${eventIndex}`);
                if (sortContainer) sortContainer.innerHTML = '';

                // 2. æ”¶é›†è¡çª
                for (let i = 1; i <= state.rankCount; i++) {
                    const currentTime = ranks[i]; // å¾ç‰©ä»¶è®€å–
                    if (currentTime !== undefined && currentTime !== null) {
                        allRanksWithTime.push({ rank: i, time: currentTime }); 
                        
                        if (lastValidTime !== -1 && currentTime < lastValidTime) {
                            errors.push({ rank1: lastValidRank, rank2: i });
                            conflictRanks.add(lastValidRank);
                            conflictRanks.add(i);
                        }
                        lastValidTime = currentTime;
                        lastValidRank = i;
                    }
                }

                // 3. æ¨™è¨˜éŒ¯èª¤
                conflictRanks.forEach(rank => {
                    const cell = document.getElementById(`cell-${eventIndex}-${rank}`);
                    if (cell) cell.classList.add('error');
                });

                // 4. æ¸²æŸ“æŒ‰éˆ•
                if (errors.length === 0) return; 

                if (conflictRanks.size === 2) {
                    const { rank1, rank2 } = errors[0];
                    const swapContainer = document.getElementById(`swap-btn-container-${eventIndex}-${rank2}`);
                    if (swapContainer) {
                        swapContainer.innerHTML = createSwapButton(eventIndex, rank1, rank2);
                    }
                } else if (conflictRanks.size > 2) {
                    errors.forEach(({ rank1, rank2 }) => {
                        const swapContainer = document.getElementById(`swap-btn-container-${eventIndex}-${rank2}`);
                        if (swapContainer) {
                            swapContainer.innerHTML = createSwapButton(eventIndex, rank1, rank2);
                        }
                    });
                    if (sortContainer && allRanksWithTime.length > 1) {
                        sortContainer.innerHTML = createSortButton(eventIndex);
                    }
                }
            }

            // --- v1.5.0 è¡çªè™•ç†è¼”åŠ©å‡½å¼ (ä¿®æ”¹ eventId -> eventIndex) ---
            
            function createSwapButton(eventIndex, rank1, rank2) {
                const swapIcon = `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M7 16V4m0 12l-3-3m3 3l3-3m6 3v12m0-12l3-3m-3 3l-3-3"></path></svg>`;
                return `
                    <button class="conflict-btn btn-swap" 
                            data-event-index="${eventIndex}" 
                            data-rank1="${rank1}" 
                            data-rank2="${rank2}" 
                            title="èˆ‡ç¬¬ ${rank1} åäº’æ›">
                        ${swapIcon} äº’æ›
                    </button>
                `;
            }
            
            function createSortButton(eventIndex) {
                const sortIcon = `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9M3 12h9m-9 4h9m5-4v8m0 0l-3-3m3 3l3-3"></path></svg>`;
                return `
                    <button class="cell-sort-btn btn-sort-row" 
                            data-event-index="${eventIndex}" 
                            title="è‡ªå‹•æ’åºæ­¤è¡Œæ‰€æœ‰æˆç¸¾">
                        ${sortIcon}
                    </button>
                `;
            }

            // ã€v1.6.0ã€‘åŸ·è¡Œæ™‚é–“äº’æ› (å¯«å…¥ Firebase)
            function swapTimes(eventIndex, rank1, rank2) {
                if (!isFirebaseEnabled) {
                    showToast('é›¢ç·šæ¨¡å¼ç„¡æ³•æ“ä½œ', 'error');
                    return;
                }
                const event = state.events[eventIndex];
                if (!event) return;

                const time1 = (event.ranks && event.ranks[rank1]) ? event.ranks[rank1] : null;
                const time2 = (event.ranks && event.ranks[rank2]) ? event.ranks[rank2] : null;

                // ã€v1.6.0ã€‘ä½¿ç”¨ update ä¸€æ¬¡æ›´æ–°å…©å€‹ç¯€é»
                const updates = {};
                updates[`${APP_DATA_PATH}/events/${eventIndex}/ranks/${rank1}`] = time2;
                updates[`${APP_DATA_PATH}/events/${eventIndex}/ranks/${rank2}`] = time1;

                db.ref().update(updates)
                    .catch(err => showToast(`äº’æ›å¤±æ•—: ${err.message}`, 'error'));
                // onValue æœƒè‡ªå‹•è™•ç†å¾ŒçºŒ
            }

            /**
             * ã€v1.6.0ã€‘åŸ·è¡Œè‡ªå‹•æ’åº (Req #3 Bug Fix)
             * - ä¿®æ­£ v1.5.1 çš„é‚è¼¯ä¸¦æ”¹ç‚ºå¯«å…¥ Firebase
             */
            function autoSortRow(eventIndex) {
                if (!isFirebaseEnabled) {
                    showToast('é›¢ç·šæ¨¡å¼ç„¡æ³•æ“ä½œ', 'error');
                    return;
                }
                const event = state.events[eventIndex];
                if (!event) return;
                
                // 1. æŠ“å‡ºæ‰€æœ‰æœ‰æ™‚é–“çš„ {rank, time}
                let ranksWithTime = [];
                const currentRanks = event.ranks || {};
                
                // ã€v1.6.0 ä¿®æ­£é‚è¼¯ã€‘
                // æˆ‘å€‘åªæ’åº "æœ‰æ™‚é–“" çš„ "åŸå§‹åæ¬¡"
                // e.g., ranks: { 1: 15.0, 3: 13.0, 5: 14.0 }
                for (let rank in currentRanks) {
                    const time = currentRanks[rank];
                    if (time !== undefined && time !== null) {
                        ranksWithTime.push({ rank: parseInt(rank, 10), time: time });
                    }
                }
                
                if (ranksWithTime.length < 2) return; // æ²’æ±è¥¿å¯æ’

                // 2. å–å¾— "åŸå§‹" çš„ "åæ¬¡" åˆ—è¡¨ (e.g., [1, 3, 5])
                const originalRanks = ranksWithTime.map(item => item.rank);

                // 3. å–å¾— "æ™‚é–“" åˆ—è¡¨ä¸¦ "æ’åº" (e.g., [15.0, 13.0, 14.0] -> [13.0, 14.0, 15.0])
                const sortedTimes = ranksWithTime.map(item => item.time).sort((a, b) => a - b);
                
                // 4. æº–å‚™ä¸€å€‹æ–°çš„ ranks ç‰©ä»¶
                const newRanksObject = { ...currentRanks };
                
                // 5. å°‡ "æ’åºå¾Œçš„æ™‚é–“" ä¾åºå¡å› "åŸå§‹çš„åæ¬¡"
                // e.g., newRanksObject[1] = 13.0
                //      newRanksObject[3] = 14.0
                //      newRanksObject[5] = 15.0
                originalRanks.forEach((rank, index) => {
                    newRanksObject[rank] = sortedTimes[index];
                });

                // 6. å¯«å› Firebase
                const ranksPath = `${APP_DATA_PATH}/events/${eventIndex}/ranks`;
                db.ref(ranksPath).set(newRanksObject)
                    .then(() => showToast(`é …ç›® "${event.name}" å·²è‡ªå‹•æ’åº`))
                    .catch(err => showToast(`æ’åºå¤±æ•—: ${err.message}`, 'error'));
            }


            // (åŒ v1.4.0) SaveModal funcs
            function openSaveRecordModal() {
                recordTitleInput.value = '';
                saveRecordModal.classList.remove('hidden');
                saveRecordModal.classList.add('visible');
                recordTitleInput.focus();
            }
            function closeSaveRecordModal() {
                saveRecordModal.classList.remove('visible');
                saveRecordModal.classList.add('hidden');
            }
            
            // ã€v1.6.0ã€‘å„²å­˜ "æœ¬æ©Ÿå¿«ç…§" (Req #5)
            function handleSaveRecord(e) {
                e.preventDefault();
                const title = recordTitleInput.value.trim();
                if (!title) { showToast('è«‹è¼¸å…¥ç´€éŒ„æ¨™é¡Œ', 'error'); return; }
                
                // ã€v1.6.0ã€‘å„²å­˜çš„æ˜¯ç•¶å‰ "state" (å³é›²ç«¯è³‡æ–™çš„é¡åƒ)
                const recordData = {
                    events: JSON.parse(JSON.stringify(state.events)),
                    rankCount: state.rankCount
                };
                
                state.savedRecords.push({ title: title, data: recordData });
                saveStateToLocalStorage(); // å­˜åˆ° localStorage
                renderSavedRecordsButtons();
                closeSaveRecordModal();
                showToast(`å·²å„²å­˜æœ¬æ©Ÿå¿«ç…§: ${title}`);
            }
            
            // ã€v1.6.0ã€‘"è¼‰å…¥" æœ¬æ©Ÿå¿«ç…§ (-> è¦†è“‹ Firebase)
            function loadSavedRecord(index) {
                if (!isFirebaseEnabled) {
                    showToast('é›¢ç·šæ¨¡å¼ç„¡æ³•æ“ä½œ', 'error');
                    return;
                }
                if (index < 0 || index >= state.savedRecords.length) return;
                
                const record = state.savedRecords[index];
                const dataToUpload = record.data; // { events: [...], rankCount: ... }
                
                // é¡¯ç¤ºç¢ºèªè¦–çª—
                showCustomConfirm(
                    'è¼‰å…¥æœ¬æ©Ÿå¿«ç…§',
                    `ç¢ºå®šè¦è¼‰å…¥ "${record.title}" å—ï¼Ÿ\né€™å°‡æœƒè¦†è“‹é›²ç«¯è³‡æ–™ï¼Œè®“æ‰€æœ‰äººåŒæ­¥åˆ°æ­¤ç‰ˆæœ¬ã€‚`,
                    () => {
                        db.ref(APP_DATA_PATH).set(dataToUpload)
                            .then(() => {
                                showToast(`å·²è¼‰å…¥å¿«ç…§: ${record.title} (é›²ç«¯åŒæ­¥ä¸­)`, 'success');
                                // onValue æœƒè‡ªå‹•æ›´æ–°ç•«é¢
                            })
                            .catch(err => showToast(`è¼‰å…¥å¤±æ•—: ${err.message}`, 'error'));
                    }
                );
            }

            // ã€v1.6.0ã€‘åˆªé™¤ "æœ¬æ©Ÿå¿«ç…§"
            function deleteSavedRecord(index) {
                if (index < 0 || index >= state.savedRecords.length) return;
                const title = state.savedRecords[index].title;
                state.savedRecords.splice(index, 1);
                saveStateToLocalStorage(); // æ›´æ–° localStorage
                renderSavedRecordsButtons();
                showToast(`å·²åˆªé™¤æœ¬æ©Ÿå¿«ç…§: ${title}`);
            }

            // (v1.5.0) æ“ä½œ Modal åŠŸèƒ½
            function openActionsModal() {
                actionsModal.classList.remove('hidden');
                actionsModal.classList.add('visible');
            }
            function closeActionsModal() {
                actionsModal.classList.remove('visible');
                actionsModal.classList.add('hidden');
            }

            // (v1.5.0) åŒ¯å‡º HTML (é‚è¼¯ä¸è®Š)
            function handleExportHtml() {
                if (!state.events || state.events.length === 0) {
                    showToast('æ²’æœ‰é …ç›®å¯åŒ¯å‡º', 'error');
                    return;
                }
                try {
                    const htmlContent = generateStaticHtml();
                    const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    const timestamp = new Date().toISOString().slice(0, 16).replace('T', '_').replace(':', '-');
                    link.download = `è“®å°çµ‚é»è¨ˆæ™‚çµ„_å ±è¡¨_${timestamp}.html`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                    showToast('HTML éœæ…‹å ±è¡¨å·²ä¸‹è¼‰', 'success');
                } catch (err) {
                    console.error('HTML ä¸‹è¼‰å¤±æ•—:', err);
                    showToast('HTML ä¸‹è¼‰å¤±æ•—', 'error');
                }
            }

            // (v1.5.0) ç”¢ç”Ÿéœæ…‹ HTML (å¾®èª¿ event.ranks è®€å–)
            function generateStaticHtml() {
                const rankCount = state.rankCount;
                let ths = `<th style="padding: 8px 10px; text-align: center; border: 1px solid #ccc; width: 50px;">åºè™Ÿ</th>`;
                ths += `<th style="padding: 8px 10px; text-align: left; border: 1px solid #ccc;">é …ç›®</th>`;
                for (let i = 1; i <= rankCount; i++) {
                    ths += `<th style="padding: 8px 10px; text-align: center; border: 1px solid #ccc; min-width: 80px;">${i} å</th>`;
                }
                let trs = '';
                
                (state.events || []).forEach((event, index) => {
                    if (!event) return; // v1.6.0
                    const eventRanks = event.ranks || {}; // v1.6.0

                    let tds = `<td style="padding: 6px 10px; text-align: center; border: 1px solid #ccc;">${index + 1}</td>`;
                    tds += `<td style="padding: 6px 10px; text-align: left; border: 1px solid #ccc; font-weight: 500;">${event.name}</td>`;
                    
                    for (let i = 1; i <= rankCount; i++) {
                        const timeInMs = eventRanks[i];
                        const timeText = formatMillis(timeInMs);
                        let isError = false;
                        if (timeInMs !== undefined && timeInMs !== null) {
                            let lastValidTime = -1;
                            for (let j = 1; j <= i; j++) {
                                const prevTime = eventRanks[j];
                                if (prevTime !== undefined && prevTime !== null) {
                                    if (j === i && prevTime < lastValidTime) isError = true;
                                    lastValidTime = prevTime;
                                }
                            }
                        }
                        const errorStyle = isError ? 'background-color: #fee2e2; color: #ef4444; font-weight: bold;' : '';
                        tds += `<td style="padding: 6px 10px; text-align: center; border: 1px solid #ccc; font-family: 'Courier New', monospace; ${errorStyle}">
                            ${timeText}
                        </td>`;
                    }
                    const bgStyle = (index % 2 !== 0) ? 'background-color: #f9fafb;' : '';
                    trs += `<tr style="${bgStyle}">${tds}</tr>`;
                });
                const staticStyles = `
                    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans TC', sans-serif; background-color: #f3f4f6; padding: 20px; font-size: 14px; }
                    .container { max-width: 1200px; margin: 0 auto; background-color: white; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); overflow: hidden; }
                    h1 { text-align: center; margin: 20px 0; font-size: 24px; color: #333; }
                    table { width: 100%; border-collapse: collapse; }
                    thead { background-color: #e5e7eb; color: #1f2937; }
                `;
                return `
                    <!DOCTYPE html>
                    <html lang="zh-Hant">
                    <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>çµ‚é»è¨ˆæ™‚å ±è¡¨</title><style>${staticStyles}</style>
                    </head><body><div class="container">
                        <h1>ğŸ… è“®å°çµ‚é»è¨ˆæ™‚çµ„ - éœæ…‹å ±è¡¨</h1>
                        <table><thead><tr>${ths}</tr></thead><tbody>${trs}</tbody></table>
                    </div></body></html>
                `;
            }

            // --- äº‹ä»¶ç›£è½ (Event Listeners) ---
            
            btnRankMinus.addEventListener('click', () => updateRankCount(-1));
            btnRankPlus.addEventListener('click', () => updateRankCount(1));
            btnOpenModal.addEventListener('click', openEventModal);
            btnCloseModal.addEventListener('click', closeEventModal);
            btnCancelModal.addEventListener('click', closeEventModal);
            eventModal.addEventListener('click', (e) => e.target === eventModal && closeEventModal());
            eventForm.addEventListener('submit', handleSaveEvent);
            timeInputForm.addEventListener('submit', handleSaveTime);
            btnCancelTime.addEventListener('click', closeTimeInputModal);
            timeInputModal.addEventListener('click', (e) => e.target === timeInputModal && closeTimeInputModal());

            // (åŒ v1.4.0) åˆªé™¤æŒ‰éˆ•
            btnDeleteTime.addEventListener('click', () => {
                if (!state.deleteTimeConfirmation) {
                    state.deleteTimeConfirmation = true;
                    btnDeleteTime.textContent = 'ç¢ºèªåˆªé™¤ï¼Ÿ';
                    btnDeleteTime.classList.remove('bg-red-100', 'text-red-700');
                    btnDeleteTime.classList.add('bg-red-500', 'text-white');
                    state.deleteTimeTimeout = setTimeout(() => {
                        state.deleteTimeConfirmation = false;
                        btnDeleteTime.textContent = 'åˆªé™¤';
                        btnDeleteTime.classList.remove('bg-red-500', 'text-white');
                        btnDeleteTime.classList.add('bg-red-100', 'text-red-700');
                        state.deleteTimeTimeout = null;
                    }, 3000);
                } else {
                    if (state.deleteTimeTimeout) { clearTimeout(state.deleteTimeTimeout); state.deleteTimeTimeout = null; }
                    handleDeleteTimeInternalLogic();
                }
            });

            /**
             * ã€v1.6.0ã€‘è¡¨æ ¼ä¸»é«”äº‹ä»¶ä»£ç† (eventIndex)
             */
            tableBody.addEventListener('click', (e) => {
                const target = e.target;
                const tr = target.closest('tr');
                if (!tr) return; 
                const eventIndex = parseInt(tr.dataset.eventIndex, 10); //ã€v1.6.0ã€‘
                if (isNaN(eventIndex)) return;

                const timeCell = target.closest('.time-cell');
                if (timeCell && !target.closest('.conflict-btn')) { 
                    openTimeInputModal(eventIndex, parseInt(timeCell.dataset.rank, 10));
                    return;
                }
                const btnToggle = target.closest('.btn-toggle-edit-icon');
                if (btnToggle) {
                    toggleEditMode(tr, false);
                    return;
                }
                const btnSave = target.closest('.btn-save-name-icon');
                if (btnSave) {
                    saveEventName(eventIndex, tr);
                    return;
                }
                const btnDelete = target.closest('.btn-delete-event-icon');
                if (btnDelete) {
                    showCustomConfirm(
                        'åˆªé™¤é …ç›®', 
                        `ç¢ºå®šè¦åˆªé™¤é …ç›® "${tr.querySelector('.event-name').textContent}" å—ï¼Ÿ (é›²ç«¯å°‡åŒæ­¥åˆªé™¤)`, 
                        () => { deleteEvent(eventIndex); }
                    );
                    return;
                }
                const btnSwap = target.closest('.btn-swap');
                if (btnSwap) {
                    const { eventIndex, rank1, rank2 } = btnSwap.dataset;
                    swapTimes(parseInt(eventIndex), parseInt(rank1), parseInt(rank2));
                    return;
                }
                const btnSort = target.closest('.btn-sort-row');
                if (btnSort) {
                    const { eventIndex } = btnSort.dataset;
                    autoSortRow(parseInt(eventIndex));
                    return;
                }
            });

            // (v1.5.0) è¡¨é ­æŒ‰éˆ•
            tableHead.addEventListener('click', (e) => {
                const btnOpen = e.target.closest('#btn-open-actions-modal');
                if (btnOpen) {
                    openActionsModal();
                }
            });
            
            // (v1.5.0) æ“ä½œ Modal ç›£è½
            btnCloseActionsModal.addEventListener('click', closeActionsModal);
            actionsModal.addEventListener('click', (e) => e.target === actionsModal && closeActionsModal());
            
            btnActionSave.addEventListener('click', () => {
                closeActionsModal();
                if (!state.events || state.events.length === 0) {
                    showToast('æ²’æœ‰é …ç›®å¯å„²å­˜', 'error');
                    return;
                }
                openSaveRecordModal();
            });
            
            btnActionExportHtml.addEventListener('click', () => {
                closeActionsModal();
                handleExportHtml();
            });

            btnActionDeleteAll.addEventListener('click', () => {
                closeActionsModal();
                if (!state.events || state.events.length === 0) {
                    showToast('ç›®å‰æ²’æœ‰é …ç›®å¯åˆªé™¤', 'error');
                    return;
                }
                showCustomConfirm(
                    'åˆªé™¤å…¨éƒ¨é …ç›®',
                    'æ‚¨ç¢ºå®šè¦åˆªé™¤ã€Œæ‰€æœ‰ã€é …ç›®å—ï¼Ÿ(é›²ç«¯å°‡åŒæ­¥åˆªé™¤)',
                    () => { deleteAllEvents(); }
                );
            });

            // (v1.4.0) æœ¬æ©Ÿå¿«ç…§å€ç›£è½
            savedRecordsContainer.addEventListener('click', (e) => {
                const target = e.target;
                const loadBtn = target.closest('.saved-record-btn');
                const deleteBtn = target.closest('.delete-record-btn');
                
                if (loadBtn) {
                    const index = parseInt(loadBtn.dataset.index, 10);
                    if (!isNaN(index)) loadSavedRecord(index); //ã€v1.6.0ã€‘
                    return;
                }
                
                if (deleteBtn) {
                    const index = parseInt(deleteBtn.dataset.index, 10);
                    if (isNaN(index)) return;
                    const title = state.savedRecords[index]?.title || 'æ­¤ç´€éŒ„';
                    showCustomConfirm(
                        'åˆªé™¤æœ¬æ©Ÿå¿«ç…§',
                        `ç¢ºå®šè¦åˆªé™¤ "${title}" é€™ç­†æœ¬æ©Ÿå¿«ç…§å—ï¼Ÿ (ä¸å½±éŸ¿é›²ç«¯)`,
                        () => { deleteSavedRecord(index); } //ã€v1.6.0ã€‘
                    );
                    return;
                }
            });

            // (v1.4.0)
            saveRecordForm.addEventListener('submit', handleSaveRecord);
            btnCancelSaveRecord.addEventListener('click', closeSaveRecordModal);
            saveRecordModal.addEventListener('click', (e) => e.target === saveRecordModal && closeSaveRecordModal());
            
            // (v1.4.0)
            customConfirmOk.addEventListener('click', () => {
                if (state.confirmCallback && !customConfirmOk.disabled) {
                    state.confirmCallback();
                }
                hideCustomConfirm();
            });
            customConfirmCancel.addEventListener('click', hideCustomConfirm);
            customConfirmModal.addEventListener('click', (e) => e.target === customConfirmModal && hideCustomConfirm());


            // --- ã€v1.6.0ã€‘Firebase å³æ™‚ç›£è½ ---
            
            function setupFirebaseListeners() {
                if (!isFirebaseEnabled) return;

                // ç›£è½é€£ç·šç‹€æ…‹
                const connectedRef = db.ref(".info/connected");
                connectedRef.on("value", (snap) => {
                    if (snap.val() === true) {
                        connectionStatusContainer.innerHTML = `
                            <div class="connection-status status-connected">
                                <div class="status-dot"></div>
                                <span>å·²é€£ç·š (å³æ™‚åŒæ­¥)</span>
                            </div>`;
                    } else {
                        connectionStatusContainer.innerHTML = `
                            <div class="connection-status status-disconnected">
                                <div class="status-dot"></div>
                                <span>é€£ç·šä¸­æ–·...</span>
                            </div>`;
                    }
                });

                // ç›£è½ä¸»è³‡æ–™ç¯€é» (Req #4)
                const appDataRef = db.ref(APP_DATA_PATH);
                appDataRef.on("value", (snapshot) => {
                    console.log("Firebase è³‡æ–™å·²æ›´æ–°ï¼");
                    const data = snapshot.val();
                    
                    if (data) {
                        // æ›´æ–°æœ¬æ©Ÿ state é¡åƒ
                        state.events = data.events || [];
                        state.rankCount = data.rankCount || 7;
                    } else {
                        // Firebase ä¸Šæ²’æœ‰è³‡æ–™
                        state.events = [];
                        state.rankCount = 7;
                    }

                    // ä½¿ç”¨æ–°è³‡æ–™é‡æ–°æ¸²æŸ“æ•´å€‹è¡¨æ ¼
                    rankCountDisplay.textContent = state.rankCount;
                    renderTable(); // é€™æœƒè‡ªå‹•è§¸ç™¼ renderTableBody å’Œ validateEventRow

                }, (error) => {
                    console.error("Firebase è®€å–å¤±æ•—:", error);
                    showToast('è³‡æ–™åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š', 'error');
                });
            }

            // --- åˆå§‹åŒ– ---
            function init() {
                loadStateFromLocalStorage(); // è¼‰å…¥ "æœ¬æ©Ÿå¿«ç…§"
                renderSavedRecordsButtons(); // æ¸²æŸ“ "æœ¬æ©Ÿå¿«ç…§" æŒ‰éˆ•
                
                if (isFirebaseEnabled) {
                    setupFirebaseListeners(); // å•Ÿå‹• Firebase ç›£è½
                    showToast('æ­¡è¿ä½¿ç”¨ è“®å°çµ‚é»è¨ˆæ™‚çµ„ v1.6.0 (é›²ç«¯ç‰ˆ)', 'success');
                } else {
                    // é›¢ç·šæ¨¡å¼
                    connectionStatusContainer.innerHTML = `
                        <div class="connection-status status-disconnected">
                            <div class="status-dot"></div>
                            <span>é›¢ç·šæ¨¡å¼ (è«‹æª¢æŸ¥ Config)</span>
                        </div>`;
                    renderTable(); // ä½¿ç”¨é è¨­ state æ¸²æŸ“
                    showToast('Firebase æœªè¨­å®šï¼Œä»¥é›¢ç·šæ¨¡å¼å•Ÿå‹•', 'error');
                }
            }

Done:
            init();
        });
    </script>
</body>
</html>